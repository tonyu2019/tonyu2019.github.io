<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/56x56logo.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/56x56logo.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/400x400logo.png" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.diandian100.cn",root:"/",scheme:"Gemini",version:"8.0.0",exturl:!0,sidebar:{position:"left",display:"always",padding:18,offset:12},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,i18n:{placeholder:"搜索...",empty:"没有找到任何搜索结果：${query}",hits_time:"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）",hits:"找到 ${hits} 个搜索结果"},path:"search.xml",localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1}}</script><meta name="description" content="除了nginx安装及配置多域名初体验里的一些配置，这里详细说下几个常用的配置：状态信息、访问日志、限制访问、错误页面、Nginx代理等。"><meta property="og:type" content="article"><meta property="og:title" content="nginx其他常用配置"><meta property="og:url" content="https://www.diandian100.cn/dbeab76f.html"><meta property="og:site_name" content="点点开发技术分享"><meta property="og:description" content="除了nginx安装及配置多域名初体验里的一些配置，这里详细说下几个常用的配置：状态信息、访问日志、限制访问、错误页面、Nginx代理等。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816140444.png"><meta property="og:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816142751.png"><meta property="og:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143106.png"><meta property="og:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143516.png"><meta property="og:image" content="https://img.diandian100.cn/20210401144054.png"><meta property="og:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143745.png"><meta property="og:image" content="https://img.diandian100.cn/20210401150311.png"><meta property="og:image" content="https://img.diandian100.cn/20210401154858.png"><meta property="og:image" content="https://img.diandian100.cn/20210401154907.png"><meta property="og:image" content="https://img.diandian100.cn/20210401160208.png"><meta property="og:image" content="https://img.diandian100.cn/20210401160218.png"><meta property="article:published_time" content="2019-08-16T05:15:07.000Z"><meta property="article:modified_time" content="2021-04-01T08:22:49.000Z"><meta property="article:author" content="托小尼"><meta property="article:tag" content="nginx配置"><meta property="article:tag" content="状态信息"><meta property="article:tag" content="访问日志"><meta property="article:tag" content="限制访问"><meta property="article:tag" content="错误页面"><meta property="article:tag" content="Nginx代理"><meta property="article:tag" content="反向代理"><meta property="article:tag" content="location"><meta property="article:tag" content="正向代理"><meta property="article:tag" content="限制ip"><meta property="article:tag" content="access_log"><meta property="article:tag" content="return"><meta property="article:tag" content="try_files"><meta property="article:tag" content="返回状态码"><meta property="article:tag" content="返回字符串"><meta property="article:tag" content="301与302"><meta property="article:tag" content="跳转页面"><meta property="article:tag" content="ip_hash"><meta property="article:tag" content="权重轮询"><meta property="article:tag" content="轮询"><meta property="article:tag" content="proxy"><meta property="article:tag" content="proxy_pass"><meta property="article:tag" content="deny"><meta property="article:tag" content="allow"><meta property="article:tag" content="expries"><meta property="article:tag" content="stub-status"><meta property="article:tag" content="index"><meta property="article:tag" content="server_name"><meta property="article:tag" content="listen"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816140444.png"><link rel="canonical" href="https://www.diandian100.cn/dbeab76f.html"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>nginx其他常用配置 | 点点开发技术分享</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3b57832214417f66931e694d19fd60b9";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">点点开发技术分享</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">记录个人日常开发笔记与技巧</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-development"><a href="/categories/rd/" rel="section"><i class="fa fa-code fa-fw"></i>开发</a></li><li class="menu-item menu-item-frontend"><a href="/categories/fe/" rel="section"><i class="fab fa-html5 fa-fw"></i>前端</a></li><li class="menu-item menu-item-database"><a href="/categories/db/" rel="section"><i class="fa fa-database fa-fw"></i>数据库</a></li><li class="menu-item menu-item-os"><a href="/categories/os/" rel="section"><i class="fab fa-linux fa-fw"></i>系统</a></li><li class="menu-item menu-item-other"><a href="/categories/other/" rel="section"><i class="far fa-paper-plane fa-fw"></i>其他</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.</span> <span class="nav-text">nginx常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx%E9%BB%98%E8%AE%A4%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">nginx默认目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.</span> <span class="nav-text">nginx默认配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%AE%B5"><span class="nav-number">4.</span> <span class="nav-text">nginx全局配置段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E9%85%8D%E7%BD%AE%E6%AE%B5"><span class="nav-number">5.</span> <span class="nav-text">http配置段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Server%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7"><span class="nav-number">6.</span> <span class="nav-text">Server常见配置属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A0%B7%E5%BC%8F"><span class="nav-number">6.0.1.</span> <span class="nav-text">常见样式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#listen%E5%B1%9E%E6%80%A7"><span class="nav-number">6.0.2.</span> <span class="nav-text">listen属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8"><span class="nav-number">6.0.2.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="nav-number">6.0.2.2.</span> <span class="nav-text">表现形式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99"><span class="nav-number">6.0.2.3.</span> <span class="nav-text">使用原则</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#server-name%E5%B1%9E%E6%80%A7"><span class="nav-number">6.0.3.</span> <span class="nav-text">server_name属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8-1"><span class="nav-number">6.0.3.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-1"><span class="nav-number">6.0.3.2.</span> <span class="nav-text">表现形式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99-1"><span class="nav-number">6.0.3.3.</span> <span class="nav-text">使用原则</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#root%E5%B1%9E%E6%80%A7"><span class="nav-number">6.0.4.</span> <span class="nav-text">root属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8-2"><span class="nav-number">6.0.4.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-2"><span class="nav-number">6.0.4.2.</span> <span class="nav-text">表现形式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#index%E5%B1%9E%E6%80%A7"><span class="nav-number">6.0.5.</span> <span class="nav-text">index属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8-3"><span class="nav-number">6.0.5.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-3"><span class="nav-number">6.0.5.2.</span> <span class="nav-text">表现形式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#return%E5%B1%9E%E6%80%A7"><span class="nav-number">6.0.6.</span> <span class="nav-text">return属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8-4"><span class="nav-number">6.0.6.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-4"><span class="nav-number">6.0.6.2.</span> <span class="nav-text">表现形式</span></a></li></ol></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%88status%EF%BC%89%E9%85%8D%E7%BD%AE"><span class="nav-number">7.</span> <span class="nav-text">Nginx状态信息（status）配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%88status%EF%BC%89%E9%85%8D%E7%BD%AE%E5%8F%8A%E4%BF%A1%E6%81%AF%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.1.</span> <span class="nav-text">Nginx状态信息（status）配置及信息详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%88status%EF%BC%89%E4%BB%8B%E7%BB%8D"><span class="nav-number">7.2.</span> <span class="nav-text">Nginx状态信息（status）介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%B5%8Bstatus%E6%A8%A1%E5%9D%97"><span class="nav-number">7.3.</span> <span class="nav-text">检测status模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87ab%E5%8E%8B%E6%B5%8B%E5%91%BD%E4%BB%A4%E6%A3%80%E6%B5%8B"><span class="nav-number">7.4.</span> <span class="nav-text">通过ab压测命令检测</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="nav-number">8.</span> <span class="nav-text">Nginx访问日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE"><span class="nav-number">9.</span> <span class="nav-text">限制访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="nav-number">10.</span> <span class="nav-text">错误页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Location%E9%85%8D%E7%BD%AE"><span class="nav-number">11.</span> <span class="nav-text">Location配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="nav-number">11.1.</span> <span class="nav-text">匹配规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="nav-number">11.1.1.</span> <span class="nav-text">正则匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%8C%B9%E9%85%8D"><span class="nav-number">11.1.2.</span> <span class="nav-text">普通匹配</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99-2"><span class="nav-number">11.2.</span> <span class="nav-text">使用原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E7%A4%BA%E4%BE%8B"><span class="nav-number">11.3.</span> <span class="nav-text">匹配示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location%E8%AF%AD%E6%B3%95%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">11.4.</span> <span class="nav-text">location语法优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AE%9E%E4%BE%8B"><span class="nav-number">11.5.</span> <span class="nav-text">nginx.conf配置文件实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#expires"><span class="nav-number">11.6.</span> <span class="nav-text">expires</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#allow"><span class="nav-number">11.7.</span> <span class="nav-text">allow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deny"><span class="nav-number">11.8.</span> <span class="nav-text">deny</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stub-status"><span class="nav-number">11.9.</span> <span class="nav-text">stub_status</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E5%88%97%E8%A1%A8"><span class="nav-number">11.10.</span> <span class="nav-text">目录列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#root%E5%92%8Calias"><span class="nav-number">11.11.</span> <span class="nav-text">root和alias</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#root"><span class="nav-number">11.11.1.</span> <span class="nav-text">root</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#alias"><span class="nav-number">11.11.2.</span> <span class="nav-text">alias</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#root%E5%92%8Calias%E5%8C%BA%E5%88%AB"><span class="nav-number">11.11.3.</span> <span class="nav-text">root和alias区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#return%E5%92%8Ctry-files"><span class="nav-number">11.12.</span> <span class="nav-text">return和try_files</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#return"><span class="nav-number">11.12.1.</span> <span class="nav-text">return</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-number">11.12.1.1.</span> <span class="nav-text">返回状态码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">11.12.1.2.</span> <span class="nav-text">返回字符串</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2"><span class="nav-number">11.12.1.3.</span> <span class="nav-text">跳转页面</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#301%E4%B8%8E302"><span class="nav-number">11.12.1.3.1.</span> <span class="nav-text">301与302</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#try-files"><span class="nav-number">11.12.2.</span> <span class="nav-text">try_files</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">11.12.2.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">11.12.2.2.</span> <span class="nav-text">执行流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">11.12.2.3.</span> <span class="nav-text">简单示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82"><span class="nav-number">11.12.2.4.</span> <span class="nav-text">转发请求</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E4%BB%A3%E7%90%86"><span class="nav-number">12.</span> <span class="nav-text">Nginx代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">12.1.</span> <span class="nav-text">正向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">12.2.</span> <span class="nav-text">反向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8C%BA%E5%88%AB"><span class="nav-number">12.3.</span> <span class="nav-text">正反向代理区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E9%80%94%E4%B8%8A"><span class="nav-number">12.3.1.</span> <span class="nav-text">用途上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E4%B8%8A"><span class="nav-number">12.3.2.</span> <span class="nav-text">安全性上</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#proxy-pass"><span class="nav-number">13.</span> <span class="nav-text">proxy_pass</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-proxy-module%E7%9A%84proxy-pass"><span class="nav-number">13.1.</span> <span class="nav-text">ngx_http_proxy_module的proxy_pass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E4%BE%8B"><span class="nav-number">13.1.1.</span> <span class="nav-text">nginx反向代理实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.1.1.1.</span> <span class="nav-text">代理配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="nav-number">13.1.1.2.</span> <span class="nav-text">后端服务配置环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">13.1.1.3.</span> <span class="nav-text">重载配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%84%E8%A7%88%E6%95%88%E6%9E%9C"><span class="nav-number">13.1.1.4.</span> <span class="nav-text">预览效果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-stream-proxy-module%E7%9A%84proxy-pass"><span class="nav-number">13.2.</span> <span class="nav-text">ngx_stream_proxy_module的proxy_pass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ngx-stream-proxy-module%E6%A8%A1%E5%9D%97%E7%9A%84proxy-pass%E7%94%A8%E6%B3%95"><span class="nav-number">13.2.1.</span> <span class="nav-text">ngx_stream_proxy_module模块的proxy_pass用法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AAproxy-pass%E7%9A%84%E5%85%B3%E7%B3%BB%E5%92%8C%E5%8C%BA%E5%88%AB"><span class="nav-number">13.3.</span> <span class="nav-text">两个proxy_pass的关系和区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">13.4.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx-upstream%E6%A8%A1%E5%9D%97"><span class="nav-number">13.4.1.</span> <span class="nav-text">nginx upstream模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%AF%A6%E8%A7%A3"><span class="nav-number">13.4.2.</span> <span class="nav-text">属性详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="nav-number">13.4.3.</span> <span class="nav-text">后端服务状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E4%BE%8B"><span class="nav-number">13.4.4.</span> <span class="nav-text">负载均衡实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.4.1.</span> <span class="nav-text">负载均衡配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.4.2.</span> <span class="nav-text">后端配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#9001%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.4.2.1.</span> <span class="nav-text">9001后端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9002%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.4.2.2.</span> <span class="nav-text">9002后端配置文件</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">13.4.4.3.</span> <span class="nav-text">重启配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%84%E8%A7%88"><span class="nav-number">13.4.4.4.</span> <span class="nav-text">预览</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="nav-number">13.4.5.</span> <span class="nav-text">负载均衡调度算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2%E5%AE%9E%E4%BE%8B"><span class="nav-number">13.4.6.</span> <span class="nav-text">加权轮询实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">13.4.6.1.</span> <span class="nav-text">负载均衡配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">13.4.6.2.</span> <span class="nav-text">后端配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#9001%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">13.4.6.2.1.</span> <span class="nav-text">9001后端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9002%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">13.4.6.2.2.</span> <span class="nav-text">9002后端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9003%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.6.2.3.</span> <span class="nav-text">9003后端配置文件</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E9%85%8D%E7%BD%AE-1"><span class="nav-number">13.4.6.3.</span> <span class="nav-text">重启配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%84%E8%A7%88-1"><span class="nav-number">13.4.6.4.</span> <span class="nav-text">预览</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ip-hash%E5%AE%9E%E4%BE%8B"><span class="nav-number">13.4.7.</span> <span class="nav-text">ip_hash实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">13.4.7.1.</span> <span class="nav-text">负载均衡配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">13.4.7.2.</span> <span class="nav-text">后端配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#9001%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">13.4.7.2.1.</span> <span class="nav-text">9001后端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9002%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">13.4.7.2.2.</span> <span class="nav-text">9002后端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9003%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">13.4.7.2.3.</span> <span class="nav-text">9003后端配置文件</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E9%85%8D%E7%BD%AE-2"><span class="nav-number">13.4.7.3.</span> <span class="nav-text">重启配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%84%E8%A7%88-2"><span class="nav-number">13.4.7.4.</span> <span class="nav-text">预览</span></a></li></ol></li></ol></li></ol></li></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="托小尼" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">托小尼</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">219</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">1467</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cDovL3dwYS5xcS5jb20vbXNncmQ/dj0zJnVpbj02NDY1NDc5ODkmc2l0ZT1xcSZtZW51PXllcw==" title="QQ → http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;646547989&amp;site&#x3D;qq&amp;menu&#x3D;yes"><i class="fab fa-qq fa-fw"></i>QQ</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOnRvbnl5dUB2aXAucXEuY29t" title="E-Mail → mailto:tonyyu@vip.qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span></span></div></section></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Rvbnl1MjAxOQ==" title="关注我" aria-label="关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.diandian100.cn/dbeab76f.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="托小尼"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="点点开发技术分享"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">nginx其他常用配置</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-08-16 13:15:07" itemprop="dateCreated datePublished" datetime="2019-08-16T13:15:07+08:00">2019-08-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-04-01 16:22:49" itemprop="dateModified" datetime="2021-04-01T16:22:49+08:00">2021-04-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/linux/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Changyan：</span> <a title="changyan" href="/dbeab76f.html#SOHUCS" itemprop="discussionUrl"><span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="dbeab76f.html" itemprop="commentCount"></span></a></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>20k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>18 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>除了<a href="https://www.diandian100.cn/b5f2e1e2.html"><code>nginx</code>安装及配置多域名初体验</a>里的一些配置，这里详细说下几个常用的配置：状态信息、访问日志、限制访问、错误页面、<code>Nginx</code>代理等。</p><a id="more"></a><h2 id="nginx常用命令"><a href="#nginx常用命令" class="headerlink" title="nginx常用命令"></a>nginx常用命令</h2><blockquote><p><strong>nginx -v：查看nginx版本</strong></p><p><strong>nginx -s stop：停止nginx服务</strong></p><p><strong>nginx -s reload：平滑重新加载nginx配置文件</strong></p><p><strong>nginx -t：检查默认配置文件</strong></p><p><strong>nginx -t -c file.conf：指定配置文件进行检查</strong></p></blockquote><h2 id="nginx默认目录"><a href="#nginx默认目录" class="headerlink" title="nginx默认目录"></a>nginx默认目录</h2><blockquote><p>工作目录：/etc/nginx</p><p>执行文件: /usr/sbin/nginx</p><p>日志目录：/var/log/nginx</p><p>启动文件：/etc/init.d/nginx</p><p>web目录：/var/www/html/，首页文件是index.nginx-debian.html</p><p>​ /usr/share/nginx/html/ 首页文件是index.html</p></blockquote><h2 id="nginx默认配置文件"><a href="#nginx默认配置文件" class="headerlink" title="nginx默认配置文件"></a>nginx默认配置文件</h2><blockquote><p>默认文件：/etc/nginx/nginx.conf</p><p>其他目录：/etc/nginx/{sites-available/sites-enabled/conf.d}</p></blockquote><p>配置文件结构</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|- 全局配置段</span><br><span class="line">│  ├─ http配置段</span><br><span class="line">│  │  ├─ server配置段(项目或者应用)</span><br><span class="line">│  │  │  ├─ location配置段(url配置)</span><br></pre></td></tr></table></figure><h2 id="nginx全局配置段"><a href="#nginx全局配置段" class="headerlink" title="nginx全局配置段"></a>nginx全局配置段</h2><p>主要是全局性的和服务级别的属性配置，常见的主要有以下几种设置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> 					设置使用用户(worker)</span><br><span class="line">worker_processes 		进行增大并发连接数的处理 跟cpu保持一致 八核设置八个</span><br><span class="line">error_log 				nginx的错误日志</span><br><span class="line">pid  					nginx服务启动时候pid </span><br><span class="line">events					定义事件相关的属性</span><br><span class="line">worker_connections 	一个进程允许处理的最大连接数</span><br><span class="line">use 					定义使用的内核模型</span><br></pre></td></tr></table></figure><h2 id="http配置段"><a href="#http配置段" class="headerlink" title="http配置段"></a>http配置段</h2><p>主要配置server通用的一些配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span> mime.types;              <span class="comment"># 文件扩展名与文件类型映射表</span></span><br><span class="line"><span class="attribute">default_type</span> application/octet-stream;   <span class="comment"># 默认文件类型</span></span><br><span class="line"><span class="attribute">sendfile</span> <span class="literal">on</span>;                  <span class="comment"># 开启高效文件传输模式。</span></span><br><span class="line"><span class="attribute">autoindex</span> <span class="literal">on</span>;                 <span class="comment"># 开启目录列表访问，合适下载服务器，默认关闭。</span></span><br><span class="line"><span class="attribute">tcp_nopush</span> <span class="literal">on</span>;                <span class="comment"># 防止网络阻塞</span></span><br><span class="line"><span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;                <span class="comment"># 防止网络阻塞</span></span><br><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">120</span>;            <span class="comment"># 长连接超时时间，单位是秒</span></span><br><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;   <span class="comment"># 开启gzip压缩输出</span></span><br></pre></td></tr></table></figure><h2 id="Server常见配置属性"><a href="#Server常见配置属性" class="headerlink" title="Server常见配置属性"></a>Server常见配置属性</h2><p>server配置段最重要的属性是listen和server_name。它们都是用于匹配并处理请求的。</p><h4 id="常见样式"><a href="#常见样式" class="headerlink" title="常见样式"></a>常见样式</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> 端口;</span><br><span class="line">  <span class="attribute">server_name</span> 主机名;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="listen属性"><a href="#listen属性" class="headerlink" title="listen属性"></a>listen属性</h4><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><p>定义Server监听的ip和port，当ip/port匹配时候才进行下一步匹配</p><h5 id="表现形式"><a href="#表现形式" class="headerlink" title="表现形式"></a>表现形式</h5><table><thead><tr><th>形式</th><th>描述</th><th>示例</th><th>完整示例</th></tr></thead><tbody><tr><td>IP:Port</td><td>地址精确表示样式</td><td>listen 10.10.10.10:99</td><td>listen 10.10.10.10:99</td></tr><tr><td>IP</td><td>自动监听 IP:80地址</td><td>listen 10.10.10.10</td><td>listen 10.10.10.10:80</td></tr><tr><td>Port</td><td>自动监听 全地址:Port</td><td>listen 99或 [::]:99</td><td>listen 0.0.0.0:99</td></tr><tr><td>default_server</td><td>自动使用默认的地址</td><td>listen default_server</td><td>listen localhost:80</td></tr></tbody></table><h5 id="使用原则"><a href="#使用原则" class="headerlink" title="使用原则"></a>使用原则</h5><p>首先将所有样式补全成IP:Port,然后匹配,匹配Server多，那么接着使用Server_name匹配</p><h4 id="server-name属性"><a href="#server-name属性" class="headerlink" title="server_name属性"></a>server_name属性</h4><h5 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h5><p>定义Server监听的域名，当域名匹配时候才进行下一步操作</p><h5 id="表现形式-1"><a href="#表现形式-1" class="headerlink" title="表现形式"></a>表现形式</h5><table><thead><tr><th>格式</th><th>完整样式</th><th>前缀正则样式</th><th>后缀正则样式</th><th>禁止非法域名或IP</th></tr></thead><tbody><tr><td>形式</td><td><span class="exturl" data-url="aHR0cDovL3d3dy5leGFtcGxlLmNvbS8=">www.example.com<i class="fa fa-external-link-alt"></i></span></td><td>*.example.com</td><td><span class="exturl" data-url="aHR0cDovL3d3dy5leGFtcGxlLw==">www.example<i class="fa fa-external-link-alt"></i></span>.*</td><td>_</td></tr></tbody></table><h5 id="使用原则-1"><a href="#使用原则-1" class="headerlink" title="使用原则"></a>使用原则</h5><p>优先使用完整样式,然后使用前缀正则样式,最后使用后缀正则样式,如果正则样式相同的时候,匹配最长,否则就走非法规则。</p><p>非法域名/IP，表示请求到该主机上一个不存在的IP或者域名</p><h4 id="root属性"><a href="#root属性" class="headerlink" title="root属性"></a>root属性</h4><p>后面location中会详细介绍该属性</p><h5 id="作用-2"><a href="#作用-2" class="headerlink" title="作用"></a>作用</h5><p>定义Server相应请求的html文件所在路径</p><h5 id="表现形式-2"><a href="#表现形式-2" class="headerlink" title="表现形式"></a>表现形式</h5><p>root /var/www/html;</p><h4 id="index属性"><a href="#index属性" class="headerlink" title="index属性"></a>index属性</h4><h5 id="作用-3"><a href="#作用-3" class="headerlink" title="作用"></a>作用</h5><p>定义响应请求后返回的文件名称或格式</p><h5 id="表现形式-3"><a href="#表现形式-3" class="headerlink" title="表现形式"></a>表现形式</h5><p>index index.html index.htm index.nginx-debian.html;</p><h4 id="return属性"><a href="#return属性" class="headerlink" title="return属性"></a>return属性</h4><p>location中会详细介绍该属性</p><h5 id="作用-4"><a href="#作用-4" class="headerlink" title="作用"></a>作用</h5><p>定义响应请求后返回的http状态码</p><h5 id="表现形式-4"><a href="#表现形式-4" class="headerlink" title="表现形式"></a>表现形式</h5><p>return 444;</p><h2 id="Nginx状态信息（status）配置"><a href="#Nginx状态信息（status）配置" class="headerlink" title="Nginx状态信息（status）配置"></a><code>Nginx</code>状态信息（<code>status</code>）配置</h2><h3 id="Nginx状态信息（status）配置及信息详解"><a href="#Nginx状态信息（status）配置及信息详解" class="headerlink" title="Nginx状态信息（status）配置及信息详解"></a><code>Nginx</code>状态信息（<code>status</code>）配置及信息详解</h3><p>​ <code>nginx</code>与<code>php-fpm</code>一样内建了一个状态页，对于想了解<code>nginx</code>的状态以及监控<code>nginx</code>非常有帮助。为了后续的<code>zabbix</code>监控，我们需要先了解一下<code>nginx</code>的状态页。</p><h3 id="Nginx状态信息（status）介绍"><a href="#Nginx状态信息（status）介绍" class="headerlink" title="Nginx状态信息（status）介绍"></a><code>Nginx</code>状态信息（<code>status</code>）介绍</h3><p>​ <code>Nginx</code>软件在编译时又一个<code>with-http_stub_status_module</code>模块，这个模块功能是记录<code>Nginx</code>的基本访问状态信息，让使用者了解<code>Nginx</code>的工作状态。<br>要想使用状态模块，在编译时必须增加<code>--with-http_stub_status_module</code>参数。</p><h3 id="检测status模块"><a href="#检测status模块" class="headerlink" title="检测status模块"></a>检测status模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Tony-PC:~# nginx -V</span><br><span class="line">nginx version: nginx/1.13.12</span><br><span class="line">built with OpenSSL 1.1.0h  27 Mar 2018</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --with-cc-opt=&#x27;-g -O2 -fdebug-prefix-map=/build/nginx-THAKdv/nginx-1.13.12=. -fstack-protector-strong -Wformat -Werror=format-security -fPIC -Wdate-time -D_FORTIFY_SOURCE=2&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -fPIC&#x27; --prefix=/usr/share/nginx --c</span><br><span class="line">onf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --modules-path=/usr/lib/nginx/modules --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module</span><br></pre></td></tr></table></figure><h3 id="通过ab压测命令检测"><a href="#通过ab压测命令检测" class="headerlink" title="通过ab压测命令检测"></a><strong>通过ab压测命令检测</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd-tools</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装测试工具</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ab -kc 1000 -n 100000 http://192.168.119.10/</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n requests <span class="comment">#执行的请求数，即一共发起多少请求。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c concurrency <span class="comment">#请求并发数。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -k <span class="comment">#启用HTTP KeepAlive功能，即在一个HTTP会话中执行多个请求。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行测试</span></span><br></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816140444.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 596 # 正在处理的活动连接数596个</span><br><span class="line">server accepts handled requests # 服务器接收的请求数</span><br><span class="line"> 2604 2604 3712 </span><br><span class="line"><span class="meta"> #</span><span class="bash"> nginx启动到现在共处理了2604个链接</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> nginx共成功创建2604次握手</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> handled requests表示处理了3712次请求</span></span><br><span class="line">Reading: 0 Writing: 1 Waiting: 595 </span><br><span class="line"><span class="meta">#</span><span class="bash"> Reading： nginx读取到的header信息数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Writing： nginx返回给客户端的header数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Waiting： 已处理完，等待下次请求的连接数</span></span><br></pre></td></tr></table></figure><h2 id="Nginx访问日志"><a href="#Nginx访问日志" class="headerlink" title="Nginx访问日志"></a><code>Nginx</code>访问日志</h2><p>日志功能对每个用户访问网站的日志信息记录到指定的日志文件里，开发运维人员可以分析用户的浏览器行为。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span>  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"><span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line"><span class="comment"># log_format    记录日志的格式，可定义多种格式</span></span><br><span class="line"><span class="comment"># accsss_log    指定日志文件的路径以及格式</span></span><br><span class="line"><span class="comment">#log_format是日志关键字参数，不能变;main是日志格式指定的标签，记录日志时通过main标签选择指定的格式。 </span></span><br></pre></td></tr></table></figure><p><code>log_format</code>参数：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr    记录客户端ip</span><br><span class="line">$remote_user    远程用户，没有就是 “-”</span><br><span class="line">$time_local 　　 对应[14/Aug/2018:18:46:52 +0800]</span><br><span class="line">$request　　　 　对应请求信息&quot;GET /favicon.ico HTTP/1.1&quot;</span><br><span class="line">$status　　　  　状态码</span><br><span class="line">$body_bytes_sent　　571字节 请求体的大小</span><br><span class="line">$http_referer　　对应“-”　　由于是直接输入浏览器就是 -</span><br><span class="line">$http_user_agent　　客户端身份信息</span><br><span class="line">$http_x_forwarded_for　　记录客户端的来源真实ip 97.64.34.118</span><br></pre></td></tr></table></figure><p>日志效果：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">79</span><span class="variable">.107</span><span class="variable">.136</span><span class="variable">.94</span> - - [<span class="number">16</span>/Aug/<span class="number">2019</span>:<span class="number">14</span>:<span class="number">17</span>:<span class="number">44</span> +<span class="number">0800</span>] <span class="string">&quot;GET / HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">3706</span> <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.</span></span><br><span class="line"><span class="string">36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure><h2 id="限制访问"><a href="#限制访问" class="headerlink" title="限制访问"></a>限制访问</h2><p>如果哪天发现你的<code>nginx</code>很慢，或者检查<code>access.log</code>时候，有一个<code>some body</code>疯狂请求你的<code>nginx server</code>，那么可以禁止这个<code>IP</code>访问</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制ip或ip段访问；禁止访问/av/底下的资源</span></span><br><span class="line"><span class="attribute">location</span> /av &#123;</span><br><span class="line">    <span class="attribute">deny</span> <span class="number">122.71.240.254</span>;</span><br><span class="line">    <span class="comment">#alias /opt/nginx1-12/html/av;</span></span><br><span class="line">    <span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用浏览器访问，提示如下：</p><p><img data-src="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816142751.png"></p><p>且日志里自动写入了该条访问记录，状态码为：403</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">180.169.32.34 - - [16&#x2F;Aug&#x2F;2019:14:30:28 +0800] &quot;GET &#x2F;av HTTP&#x2F;1.1&quot; 403 169 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Windows NT 10.0; WOW64; Trident&#x2F;7.0; rv</span><br><span class="line">:11.0) like Gecko Core&#x2F;1.70.3722.400 QQBrowser&#x2F;10.5.3738.400&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><h2 id="错误页面"><a href="#错误页面" class="headerlink" title="错误页面"></a>错误页面</h2><p>在网站运行过程中，可能因为页面不存在等原因，导致网站无法正常响应请求，此时web服务会返回系统的错误码，但是默认的错误页面很不友好。</p><p><img data-src="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143106.png">因此我们可以将404，403等页面的错误信息重定向到网站首页或者其他指定的页面，提升用户访问体验</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br></pre></td></tr></table></figure><p>修改404.html文件，重新访问一个不存在的页面提示如下：</p><p><img data-src="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143516.png"></p><h2 id="Location配置"><a href="#Location配置" class="headerlink" title="Location配置"></a><code>Location</code>配置</h2><p>location主要是根据Server匹配到的请求路径和关键字去响应和处理。</p><p>语法：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">location optional_modifier location_match &#123; ... &#125; </span><br><span class="line">location @name &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>其中：optional_modifier是匹配条件，location_match是匹配的样式，{}是要执行的操作。匹配条件主要有两种:正则/前缀字符。</p><h3 id="匹配规则"><a href="#匹配规则" class="headerlink" title="匹配规则"></a>匹配规则</h3><h4 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h4><table><thead><tr><th>类型</th><th>含义</th><th>匹配方式</th><th>优先级</th><th>样式</th></tr></thead><tbody><tr><td>`~</td><td>!~`</td><td>普通正则-敏感|不敏感</td><td>正则符号</td><td>3</td></tr><tr><td>`~*</td><td>!~*`</td><td>普通正则-不敏感|敏感</td><td>正则符号</td><td>3</td></tr></tbody></table><h4 id="普通匹配"><a href="#普通匹配" class="headerlink" title="普通匹配"></a>普通匹配</h4><table><thead><tr><th>类型</th><th>含义</th><th>匹配方式</th><th>优先级</th><th>样式</th></tr></thead><tbody><tr><td>=/路径</td><td>精确匹配</td><td>前缀</td><td>1</td><td>location = /image {}</td></tr><tr><td>^~</td><td>优先匹配</td><td>前缀</td><td>2</td><td>location ^~ /page {}</td></tr><tr><td>@</td><td>内部重定向</td><td>前缀</td><td></td><td>location @name {}</td></tr><tr><td>空 /</td><td>通用匹配</td><td>前缀</td><td>4</td><td>location / {}</td></tr></tbody></table><h3 id="使用原则-2"><a href="#使用原则-2" class="headerlink" title="使用原则"></a>使用原则</h3><p>前提：根据请求url，获取uri即除了域名/IP之外的部分，用于location匹配</p><p>如果有精确匹配，即 =/路径，找到匹配项后，结束匹配。</p><p><code>location = 路径 &#123;&#125;</code> 或者 location 完整路径 {}</p><p>如果有优先匹配，即 <code>^~</code>，找到匹配项后，结束匹配。</p><p><code>location ^~</code> 路径</p><p>如果有正则匹配，即 <code>~|!~|~*|!~*</code>，找到匹配项后，不会终止继续匹配，直到找到合适的</p><p><code>location ~*</code> 正则字符 {}</p><p>如果匹配到多个，则使用location_match最长的。</p><h3 id="匹配示例"><a href="#匹配示例" class="headerlink" title="匹配示例"></a>匹配示例</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> = / &#123;</span><br><span class="line">   <span class="comment">#精确规则A</span></span><br><span class="line">   <span class="comment"># 访问根目录会被匹配</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> = /login &#123;</span><br><span class="line">  <span class="comment">#精确规则B</span></span><br><span class="line">  <span class="comment">#完全匹配访问/login</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /static/ &#123;</span><br><span class="line">  <span class="comment"># 优先规则C</span></span><br><span class="line">  <span class="comment"># 访问/static/开头的请求且区分大小写，大写不会被匹配到</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.(gif|jpg|png|js|css)$</span> &#123;</span><br><span class="line">  <span class="comment">#正则规则D</span></span><br><span class="line">  <span class="comment"># 访问以.gif、.jpg、.png、.js、.css结尾，且区分大小写</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.png$</span> &#123;</span><br><span class="line">  <span class="comment">#正则规则E</span></span><br><span class="line">  <span class="comment"># 访问以.png结尾会被匹配，不缺分大小写</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="comment">#通用规则F</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>访问效果如下：</p><blockquote><p>访问根目录/， 比如<code>http://a.com/</code> 将匹配规则A</p><p>访问 <code>http://a.com/login</code> 将匹配规则B</p><p>访问 <code>http://a.com/static/a.html</code> 将匹配规则C</p><p>访问 <code>http://a.com/a.gif</code>, <code>http://a.com/b.png</code> 规则D和E均适合，按顺序优先使用规则D，而 <code>http://a.com/static/c.png</code> 则优先匹配到规则C</p><p>访问 <code>http://a.com/a.PNG</code> 则匹配规则E，因为规则E不区分大小写。</p><p>访问 <code>http://a.com/category/id/1111</code> 则最终匹配到规则H。</p></blockquote><p>注意：</p><p>1 location中的location_match字符有无”/“不受影响。/user/等同/user。</p><p>2 对于访问网站域名(<span class="exturl" data-url="aHR0cHM6Ly93d3cuZGlhbmRpYW4xMDAvKSVFRiVCQyU4QyVFNSVCMCVCRSVFOSU4MyVBOCVFNiU5QyU4OSVFNiU5NyVBMCZxdW90Oy8mcXVvdDslRTQlQjglOEQlRTUlOEYlOTclRTUlQkQlQjElRTUlOTMlOEQlRTMlODAlODIlRTUlOUIlQTAlRTQlQjglQkElRTYlQjUlOEYlRTglQTclODglRTUlOTklQTglRTQlQkMlOUElRTglODclQUElRTUlOEElQTglRTglQTElQTUlRTUlODUlQTgmcXVvdDsvJnF1b3Q7JUUzJTgwJTgy">https://www.diandian100/)，尾部有无&quot;/&quot;不受影响。因为浏览器会自动补全&quot;/&quot;。<i class="fa fa-external-link-alt"></i></span></p><p>3 对于访问网站域名后面的路径(<a href="https://www.diandian100.cn/archives/)%E3%80%82%E5%B0%BE%E9%83%A8%E7%9A%84&quot;/&quot;%E5%BE%88%E9%87%8D%E8%A6%81%E3%80%82">https://www.diandian100.cn/archives/)。尾部的&quot;/&quot;很重要。</a></p><p>URL尾部的”/“表示目录，没有”/“表示文件，而且文件找不到的话，会发生重定向。</p><p>​ /archives/：表示服务器会自动去该目录下找对应的默认文件。</p><p>​ /archives：表示服务器会先去找archives文件，找不到的话会将archives当成目录，重定向到/archives/，去该目录下找默认文件。</p><h3 id="location语法优先级"><a href="#location语法优先级" class="headerlink" title="location语法优先级"></a><code>location</code>语法优先级</h3><table><thead><tr><th>字符</th><th>优先级</th><th>解释</th></tr></thead><tbody><tr><td>=</td><td>1</td><td>表示精确匹配，如果找到，立即停止搜索并立即处理此请求。</td></tr><tr><td>^~</td><td>2</td><td>以某个字符串开头，即表示只匹配普通字符（跟空格类似，但是它优先级比空格高）。使用前缀匹配，^表示“非”，即不查询正则表达式。如果匹配成功，并且所匹配的字符串是最长的， 则不再匹配其他location。</td></tr><tr><td>~</td><td>3</td><td>表示执行一个正则匹配，区分大小写匹配</td></tr><tr><td>~*</td><td>4</td><td>表示执行一个正则匹配，不区分大小写匹配， 注意，如果是运行 Nginx server 的系统本身对大小写不敏感，比如 Windows ，那么 ~* 和 ~ 这两个表现是一样的</td></tr><tr><td>/</td><td>5</td><td>通用匹配，任何请求都会匹配到</td></tr></tbody></table><h3 id="nginx-conf配置文件实例"><a href="#nginx-conf配置文件实例" class="headerlink" title="nginx.conf配置文件实例"></a><code>nginx.conf</code>配置文件实例</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> diandian100.cn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#优先级1,精确匹配，根路径</span></span><br><span class="line">    <span class="attribute">location</span> =/ &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">400</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#优先级2,以某个字符串开头,以av开头的，优先匹配这里，区分大小写</span></span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /av &#123;</span><br><span class="line">       <span class="attribute">root</span> /data/av/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#优先级3，区分大小写的正则匹配，匹配/media*****路径</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /media</span> &#123;</span><br><span class="line">          <span class="attribute">alias</span> /data/static/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#优先级4 ，不区分大小写的正则匹配，所有的****.jpg|gif|png 都走这里</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* .*\.(jpg|gif|png|js|css)$</span> &#123;</span><br><span class="line">       <span class="attribute">root</span>  /data/av/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#优先7，通用匹配</span></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="expires"><a href="#expires" class="headerlink" title="expires"></a>expires</h3><p>控制页面资源在浏览器缓存的时间。在指定事件内再次访问该静态资源，将不再像nginx发送请求，而是直接从浏览器缓存中获取。</p><p>使用本指令可以控制HTTP应答中的“Expires”和“Cache-Control”的头标，（起到控制页面缓存的作用）。</p><blockquote><p><strong>语法：</strong> <em>expires [time|epoch|max|off]</em></p><p><strong>默认值：</strong> <em>expires off</em></p><p><strong>作用域：</strong> <em>http, server, location</em></p></blockquote><p>可以在time值中使用正数或负数。“Expires”头标的值将通过当前系统时间加上您设定的 time值来获得。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">expires</span> <span class="number">2s</span>; <span class="comment"># 2秒</span></span><br><span class="line"><span class="attribute">expires</span> <span class="number">2m</span>; <span class="comment"># 2分钟</span></span><br><span class="line"><span class="attribute">expires</span> <span class="number">2h</span>; <span class="comment"># 2小时</span></span><br><span class="line"><span class="attribute">expires</span> <span class="number">2d</span>; <span class="comment"># 2天</span></span><br><span class="line"><span class="attribute">expires</span> -<span class="number">1</span>; <span class="comment"># 不缓存，用于过期;指定“Expires”的值为当前服务器时间-1s，即永远过期。</span></span><br><span class="line"><span class="attribute">expires</span> epoch; <span class="comment"># 指定“Expires”的值为 1 January,1970,00:00:01 GMT</span></span><br><span class="line"><span class="attribute">expires</span> max; <span class="comment"># 指定“Expires”的值为31 December2037 23:59:59GMT,&quot;Cache-Control&quot;的值为10年。</span></span><br><span class="line"><span class="attribute">expires</span> <span class="literal">off</span>; <span class="comment"># 不修改“Expires”和&quot;Cache-Control&quot;的值</span></span><br></pre></td></tr></table></figure><h3 id="allow"><a href="#allow" class="headerlink" title="allow"></a>allow</h3><p>允许某个ip或者一个ip段访问.如果指定unix:,那将允许socket的访问.注意：unix在1.5.1中新加入的功能，如果你的版本比这个低，请不要使用这个方法。</p><blockquote><p>语法: allow address | CIDR | unix: | all;<br>默认值: —<br>配置段: http, server, location, limit_except</p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">allow</span> <span class="number">192.168.1.0</span>; <span class="comment"># 允许单个ip</span></span><br><span class="line">  <span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>; <span class="comment"># 允许ip段</span></span><br><span class="line">  <span class="attribute">allow</span> all; <span class="comment"># 允许所有ip</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="deny"><a href="#deny" class="headerlink" title="deny"></a>deny</h3><p>禁止某个ip或者一个ip段访问.如果指定unix:,那将禁止socket的访问.注意：unix在1.5.1中新加入的功能，如果你的版本比这个低，请不要使用这个方法。</p><blockquote><p>语法: deny address | CIDR | unix: | all;<br>默认值: —<br>配置段: http, server, location, limit_except</p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">deny</span> <span class="number">192.168.1.0</span>; <span class="comment"># 禁止单个ip</span></span><br><span class="line">  <span class="attribute">deny</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>; <span class="comment"># 禁止ip段</span></span><br><span class="line">  <span class="attribute">deny</span> all; <span class="comment"># 禁止所有ip</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>综合示例</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">deny</span>  <span class="number">192.168.1.1</span>;</span><br><span class="line">  <span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">24</span>;</span><br><span class="line">  <span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>;</span><br><span class="line">  <span class="attribute">allow</span> <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">  <span class="attribute">deny</span>  all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上的例子先禁止了192.16.1.1，接下来允许了3个网段，其中包含了一个ipv6，最后未匹配的IP全部禁止访问. 在实际生产环境中，我们也会使用nginx 的geo模块配合使用</p><h3 id="stub-status"><a href="#stub-status" class="headerlink" title="stub_status"></a>stub_status</h3><p>提供对基本信息状态的访问</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /status &#123;</span><br><span class="line">        <span class="attribute">stub_status</span> <span class="literal">on</span>; <span class="comment"># 开启nginx的状态页面，默认关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>预览返回结果：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 1162164 1162164 2031091 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0 </span><br></pre></td></tr></table></figure><p>返回各数据项说明：</p><p>Active connections: 当前nginx正在处理的活动连接数.</p><p>Server accepts handled requests request_time: nginx总共处理了1162164 个连接；成功创建1162164 握手(证明中间没有失败的)；总共处理了2031091 个请求。</p><p>Reading: nginx读取到客户端的Header信息数。</p><p>Writing：nginx返回给客户端的Header信息数.</p><p>Waiting: 开启keep-alive的情况下,这个值等于 active – (reading + writing),意思就是nginx已经处理完成,正在等候下一次请求指令的驻留连接。</p><p>所以,在访问效率高,请求很快被处理完毕的情况下,Waiting数比较多是正常的.如果reading +writing数较多,则说明并发访问量非常大,正在处理过程中。</p><h3 id="目录列表"><a href="#目录列表" class="headerlink" title="目录列表"></a>目录列表</h3><p>Nginx默认是不允许列出整个目录的。如需此功能，打开nginx.conf文件或你要启用目录浏览虚拟主机的配置文件，在server或location 段里添加上autoindex on;来启用目录流量，</p><table><thead><tr><th>配置</th><th>说明</th></tr></thead><tbody><tr><td>autoindex</td><td>是否开启目录自动索引</td></tr><tr><td>autoindex_exact_size</td><td>默认为 <strong>on</strong>，显示出文件的确切大小，单位是bytes。 改为 off 后，显示出文件的大概大小，单位是kB或者MB或者GB</td></tr><tr><td>autoindex_localtime</td><td>默认为off，显示的文件时间为GMT时间。 改为on后，显示的文件时间为文件的服务器时间</td></tr></tbody></table><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /upload &#123;</span><br><span class="line">        <span class="attribute">alias</span> /mnt/vdb1/test/uploads;	<span class="comment"># 指定查看文件列表路径(绝对路径)</span></span><br><span class="line">        <span class="attribute">autoindex</span> <span class="literal">on</span>;	<span class="comment"># 开启目录自动索引</span></span><br><span class="line">        <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;	<span class="comment"># 默认on，显示文件确切大小(bytes)。off表示显示文件的大概大小(kB/MB/...)</span></span><br><span class="line">        <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;	<span class="comment"># 默认off，显示的文件时间为GMT时间。on表示显示文件的服务器时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>预览效果</p><p><img data-src="https://img.diandian100.cn/20210401144054.png"></p><h3 id="root和alias"><a href="#root和alias" class="headerlink" title="root和alias"></a><code>root</code>和<code>alias</code></h3><p>nginx指定文件路径有root和alias两种方法。root和alias区别在nginx如何解释location后面的url，这会使得两者分别以不同的方式讲请求映射到服务器文件上</p><h4 id="root"><a href="#root" class="headerlink" title="root"></a>root</h4><p>root的处理结果是：root路径+location位置</p><p>语法</p><blockquote><p>语法 root 路径;<br>默认值 root html;<br>配置块 http{} server {} location{}</p></blockquote><p>实例</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /av &#123;</span><br><span class="line">				<span class="comment"># 注意这里可有可无结尾的/</span></span><br><span class="line">        <span class="attribute">root</span> /data/av;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>请求url是localhost/av/index.html时，web服务器会返回服务器上的/data/av/av/index.html</p><h4 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h4><p>alias的处理结果是：使用alias路径替换location路径</p><p>alias是一个目录的别名，注意alias必须有 “/“ 结束！alias只能位于location块中</p><p>语法</p><blockquote><p>语法： alias 路径<br>配置块 location{}</p></blockquote><p>实例</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /av &#123;</span><br><span class="line">    <span class="attribute">alias</span> /data/static/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求url是localhost/av/index.html时，web服务器会返回服务器上的/data/static/index.html</p><h4 id="root和alias区别"><a href="#root和alias区别" class="headerlink" title="root和alias区别"></a>root和alias区别</h4><p>root与alias主要区别在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上。</p><blockquote><p>1、<strong>root的处理结果是：root路径＋location路径；alias的处理结果是：使用alias路径替换location路径</strong><br>2、<strong>alias是一个目录别名的定义；root则是最上层目录的定义。</strong><br>3、<strong>alias后面必须要用“/”结束，否则会找不到文件的；而root则可有可无</strong><br>4、<strong>alias只能位于location块中；root可以不放在location中(可以放在http、server、location中)</strong><br>5、<strong>一般情况下，在location /中配置root；在location /other中配置alias</strong></p></blockquote><h3 id="return和try-files"><a href="#return和try-files" class="headerlink" title="return和try_files"></a>return和try_files</h3><h4 id="return"><a href="#return" class="headerlink" title="return"></a>return</h4><p>该指令一般用于对请求的客户端直接返回响应状态码。在该作用域内return后面的所有nginx配置都是无效的。<br>可以使用在server、location以及if配置中。</p><h5 id="返回状态码"><a href="#返回状态码" class="headerlink" title="返回状态码"></a>返回状态码</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test/ &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>通过返回的页面为： 403 Forbidden 正常的403错误返回码报错可以看出 对于单独返回返回码的场景， 可以进行过滤拦截场景使用）</p><h5 id="返回字符串"><a href="#返回字符串" class="headerlink" title="返回字符串"></a>返回字符串</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test/ &#123;</span><br><span class="line">        <span class="comment"># 响应类型</span></span><br><span class="line">        <span class="attribute">default_type</span> application/json;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&#123;&quot;name&quot;:&quot;张学友&quot;, &quot;age&quot;:18&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果要想返回字符串，必须要加上状态码，否则会报错</p><h5 id="跳转页面"><a href="#跳转页面" class="headerlink" title="跳转页面"></a>跳转页面</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test/ &#123;</span><br><span class="line">        <span class="comment"># 302跳转</span></span><br><span class="line">        <span class="attribute">return</span> https://www.diandian100.cn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>等同于</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test/ &#123;</span><br><span class="line">        <span class="comment"># 302跳转</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">302</span> https://www.diandian100.cn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们看下访问日志，可以看出进行了302跳转，并且我这边使用postman进行测试的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [31/Mar/2021:17:34:41 +0800] &quot;GET /test/ HTTP/1.1&quot; 302 145 &quot;-&quot; &quot;PostmanRuntime/7.26.8&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><p>默认为302临时跳转，你也可以指定301永久跳转</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test/ &#123;</span><br><span class="line">        <span class="comment"># 301永久跳转</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://www.diandian100.cn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>再次查看访问日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [31/Mar/2021:17:37:45 +0800] &quot;GET /test/ HTTP/1.1&quot; 301 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:87.0) Gecko/20100101 Firefox/87.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><h6 id="301与302"><a href="#301与302" class="headerlink" title="301与302"></a>301与302</h6><p>301 redirect: 301 代表永久性转移(Permanently Moved)</p><p>302 redirect: 302 代表暂时性转移(Temporarily Moved )</p><p>ps:这里也顺带记住了两个比较相近的英语单词（permanently、temporarily），嘻哈！</p><p>​ 详细来说，301和302状态码都表示重定向，就是说浏览器在拿到服务器返回的这个状态码后会自动跳转到一个新的URL地址，这个地址可以从响应的Location首部中获取（用户看到的效果就是他输入的地址A瞬间变成了另一个地址B）——这是它们的共同点。他们的不同在于。301表示旧地址A的资源已经被永久地移除了（这个资源不可访问了），<strong>搜索引擎在抓取新内容的同时也将旧的网址交换为重定向之后的网址</strong>；302表示旧地址A的资源还在（仍然可以访问），这个重定向只是临时地从旧地址A跳转到地址B，<strong>搜索引擎会抓取新的内容而保存旧的网址。</strong></p><p>1、什么是重定向啊？</p><p>​ 就是地址A跳转到地址B啦。百度百科的解释：重定向(Redirect)就是通过各种方法将各种网络请求重新定个方向转到其它位置（如：网页重定向、域名的重定向、路由选择的变化也是对数据报文经由路径的一种重定向）。</p><p>2、可是，为什么要进行重定向啊？什么时候需要重定向呢？</p><p>​ 想跳就跳，就跳的漂亮。还是借鉴百度百科：</p><p>1）网站调整（如改变网页目录结构）；</p><p>2）网页被移到一个新地址；</p><p>3）网页扩展名改变(如应用需要把.php改成.Html或.shtml)。</p><p>​ 这种情况下，如果不做重定向，则用户收藏夹或搜索引擎数据库中旧地址只能让访问客户得到一个404页面错误信息，访问流量白白丧失；再者某些注册了多个域名的网站，也需要通过重定向让访问这些域名的用户自动跳转到主站点等。</p><p>3、那么，什么时候进行301或者302跳转呢？</p><p>​ 当一个网站或者网页24—48小时内临时移动到一个新的位置，这时候就要进行302跳转，打个比方说，我有一套房子，但是最近走亲戚去亲戚家住了，过两天我还回来的。而使用301跳转的场景就是之前的网站因为某种原因需要移除掉，然后要到新的地址访问，是永久性的，就比如你的那套房子其实是租的，现在租期到了，你又在另一个地方找到了房子，之前租的房子不住了。</p><p>清晰明确而言：</p><p>使用301跳转的场景：</p><p>1）域名到期不想续费（或者发现了更适合网站的域名），想换个域名。</p><p>2）在搜索引擎的搜索结果中出现了不带www的域名，而带www的域名却没有收录，这个时候可以用301重定向来告诉搜索引擎我们目标的域名是哪一个。</p><p>3）空间服务器不稳定，换空间的时候。</p><p>使用302跳转的场景：</p><p>​ –尽量使用301跳转！</p><p>4、为什么尽量要使用301跳转？——网址劫持！</p><p>​ 这里摘录百度百科上的解释：</p><p>​ 从网址A 做一个302 重定向到网址B 时，主机 服务器的隐含意思是网址A 随时有可能改主意，重新显示本身的内容或转向其他的地方。大部分的搜索引擎在大部分情况下，当收到302 重定向时，一般只要去抓取目标网址就可以了，也就是说网址B。如果搜索引擎在遇到302 转向时，百分之百的都抓取目标网址B 的话，就不用担心网址URL 劫持了。问题就在于，有的时候搜索引擎，尤其是Google，并不能总是抓取目标网址。比如说，有的时候A 网址很短，但是它做了一个302 重定向到B 网址，而B 网址是一个很长的乱七八糟的URL 网址，甚至还有可能包含一些问号之类的参数。很自然的，A 网址更加用户友好，而B 网址既难看，又不用户友好。这时Google 很有可能会仍然显示网址A。由于搜索引擎排名算法只是程序而不是人，在遇到302 重定向的时候，并不能像人一样的去准确判定哪一个网址更适当，这就造成了网址URL 劫持的可能性。也就是说，一个不道德的人在他自己的网址A 做一个302 重定向到你的网址B，出于某种原因， Google 搜索结果所显示的仍然是网址A，但是所用的网页内容却是你的网址B 上的内容，这种情况就叫做网址URL 劫持。你辛辛苦苦所写的内容就这样被别人偷走了。302 重定向所造成的网址URL 劫持现象，已经存在一段时间了。不过到目前为止，似乎也没有什么更好的解决方法。在正在进行的谷歌大爸爸数据中心转换中，302 重定向问题也是要被解决的目标之一。从一些搜索结果来看，网址劫持现象有所改善，但是并没有完全解决。</p><p>​ 我的理解是，从网站A（网站比较烂）上做了一个302跳转到网站B（搜索排名很靠前），这时候有时搜索引擎会使用网站B的内容，但却收录了网站A的地址，这样在不知不觉间，网站B在为网站A作贡献，网站A的排名就靠前了。</p><p>​ 301跳转对查找引擎是一种对照驯良的跳转编制，也是查找引擎能够遭遇的跳转编制，它告诉查找引擎，这个地址弃用了，永远转向一个新地址，可以转移新域名的权重。而302重定向很容易被搜索引擎误认为是利用多个域名指向同一网站，那么你的网站就会被封掉，罪名是“利用重复的内容来干扰Google搜索结果的网站排名”。</p><h4 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h4><p>try_files是nginx中http_core核心模块所带的指令，主要是能替代一些rewrite的指令，提高解析效率。</p><h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><blockquote><p>格式1：<strong>try_files</strong> <code>file</code> <code>file1</code> <code>file2</code>… <code>uri</code>;</p><p>格式2：<strong>try_files</strong> <code>file</code> <code>file1</code> <code>file2</code> … =<code>code</code>;</p><p>可应用的上下文：server，location段</p></blockquote><h5 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h5><p><strong>1.按指定的file顺序查找存在的文件，并使用第一个找到的文件进行请求处理</strong></p><p><strong>2.查找路径是按照给定的root或alias为根路径来查找的</strong></p><p><strong>3.如果给出的file都没有匹配到，则重新请求最后一个参数给定的uri，就是新的location匹配</strong></p><p><strong>4.如果是格式2，如果最后一个参数是 = 404 ，若给出的file都没有匹配到，则最后返回404的响应码</strong></p><h5 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /images/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /opt/html/;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /images/default.png; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果此时客户端请求localhost/images/flag.png的话，nginx依次查找顺序为：</p><blockquote><p>1.查找文件：/opt/html/images/flag.png</p><p>2.查找文件夹(目录)下的index文件（如：/opt/html/images/flag.png/index.html）：/opt/html/images/flag.png/</p><p>3.以上都找不到请求默认文件：/opt/html/images/default.png</p></blockquote><h5 id="转发请求"><a href="#转发请求" class="headerlink" title="转发请求"></a>转发请求</h5><p>try_files中可以用过@location名称进行请求转发，如：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /images/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /opt/html/;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ <span class="variable">@none</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location <span class="variable">@none</span> &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">404</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：try_files不能用于根路径的请求处理，只能用于子路径。即：不能用于<code>location / &#123;&#125;</code>中，</strong></p><h2 id="Nginx代理"><a href="#Nginx代理" class="headerlink" title="Nginx代理"></a><code>Nginx</code>代理</h2><p><img data-src="https://raw.githubusercontent.com/tonyu2019/PicGo/master/20190816143745.png"></p><p><img data-src="https://img.diandian100.cn/20210401150311.png"></p><h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p>正向代理，也就是传说中的代理,他的工作原理就像一个跳板（<code>VPN</code>），简单的说：</p><p>我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。</p><h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>对于客户端而言，代理服务器就像是原始服务器。</p><h3 id="正反向代理区别"><a href="#正反向代理区别" class="headerlink" title="正反向代理区别"></a>正反向代理区别</h3><h4 id="用途上"><a href="#用途上" class="headerlink" title="用途上"></a>用途上</h4><p>​ 正向代理-为局域网客户端向外访问Internet服务。可以使用缓冲特性减少网络使用率。</p><p>反向代理-为局域网服务器向外提供Internet服务。可以使用负载平衡提高客户访问量。还可以基于高级URL策略和管理技术对服务进行高质量管控。</p><h4 id="安全性上"><a href="#安全性上" class="headerlink" title="安全性上"></a>安全性上</h4><p>正向代理-必须采取安全措施确保内网客户端通过它访问外部网站。隐藏客户端的身份</p><p>反向代理-对外提供服务是透明的，客户端并不知道自己访问的是一个代理。隐藏服务端的身份</p><h2 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h2><p>nginx中有两个模块都有<code>proxy_pass</code>指令。两个<code>proxy_pass</code>都是用来做后端代理的指令。</p><h3 id="ngx-http-proxy-module的proxy-pass"><a href="#ngx-http-proxy-module的proxy-pass" class="headerlink" title="ngx_http_proxy_module的proxy_pass"></a><code>ngx_http_proxy_module</code>的<code>proxy_pass</code></h3><blockquote><p>语法：proxy_pass URL;<br>场景：location, if in location, limit_except<br>说明：设置后端代理服务器的协议(protocol)和地址(address),以及location中可以匹配的一个可选的URI。协议可以是”http”或”https”。地址可以是一个域名或ip地址和端口，或者一个 unix-domain socket 路径( <span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfcHJveHlfbW9kdWxlLmh0bWwjcHJveHlfcGFzcw==">详见参考文档<i class="fa fa-external-link-alt"></i></span>)</p></blockquote><p>官方的代理属性很多，我们主要介绍proxy_pass和proxy_set_header属性。proxy_pass 指令设置被代理服务器的地址和被映射的URI，地址可以使用主机名或IP加端口号的形式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"> <span class="attribute">proxy_pass</span>        http://localhost:8000;		<span class="comment"># 设定请求跳转后的地址，可以使用hostname或IP:Port形式</span></span><br><span class="line"> <span class="attribute">proxy_set_header</span>  X-Real-IP  <span class="variable">$remote_addr</span>;	<span class="comment"># 后端请求携带原始请求的真实IP地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>proxy_pass后面的路径最后的/作用很重要!!!</p><p>示例代码：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /html/ &#123;</span><br><span class="line">	<span class="attribute">proxy_pass</span> https://www.diandian100.cn; </span><br><span class="line">	<span class="attribute">proxy_pass</span> https://www.diandian100.cn/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设我们访问的url是 <code>http://domain.com/html/test.js</code>，如何理解上述两种proxy_pass的区别呢？</p><p>对于 1 来说 <code>https://www.diandian100.cn</code>后面没有”/“，表示”/html/“ 请求(包括自己)后续的路径及其参数等关键字都由<code>https://www.diandian100.cn</code>来处理，代理后的样式如下：</p><p><code>https://www.diandian100.cn/html/test.js</code></p><p>对于 2 来所 <code>https://www.diandian100.cn</code>后面有”/“，表示”/html/“ 请求后续的路径及其参数等关键字都由<code>https://www.diandian100.cn</code>来处理，代理后的样式如下：</p><p><code>https://www.diandian100.cn/test.js</code></p><h4 id="nginx反向代理实例"><a href="#nginx反向代理实例" class="headerlink" title="nginx反向代理实例"></a>nginx反向代理实例</h4><h5 id="代理配置文件"><a href="#代理配置文件" class="headerlink" title="代理配置文件"></a>代理配置文件</h5><p>9000端口的配置文件</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /proxy &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:9001/hello/;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="后端服务配置环境"><a href="#后端服务配置环境" class="headerlink" title="后端服务配置环境"></a>后端服务配置环境</h5><p>9001端口配置文件</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /hello/ &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是代理后端&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="重载配置"><a href="#重载配置" class="headerlink" title="重载配置"></a>重载配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h5 id="预览效果"><a href="#预览效果" class="headerlink" title="预览效果"></a>预览效果</h5><p><img data-src="https://img.diandian100.cn/20210401154858.png"></p><p><img data-src="https://img.diandian100.cn/20210401154907.png"></p><h3 id="ngx-stream-proxy-module的proxy-pass"><a href="#ngx-stream-proxy-module的proxy-pass" class="headerlink" title="ngx_stream_proxy_module的proxy_pass"></a><code>ngx_stream_proxy_module</code>的<code>proxy_pass</code></h3><blockquote><p>语法： proxy_pass address;<br>场景：server<br>说明：设置后端代理服务器的地址。这个地址(address)可以是一个域名或ip地址和端口，或者一个 unix-domain socket路径(<span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL3N0cmVhbS9uZ3hfc3RyZWFtX3Byb3h5X21vZHVsZS5odG1sI3Byb3h5X3Bhc3M=">详见官方文档<i class="fa fa-external-link-alt"></i></span>))。</p></blockquote><h4 id="ngx-stream-proxy-module模块的proxy-pass用法"><a href="#ngx-stream-proxy-module模块的proxy-pass用法" class="headerlink" title="ngx_stream_proxy_module模块的proxy_pass用法"></a><code>ngx_stream_proxy_module</code>模块的<code>proxy_pass</code>用法</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">127.0.0.1:12345</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">12345</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">1s</span>; <span class="comment"># nginx与proxy_pass设置的地址的连接超时时间</span></span><br><span class="line">    <span class="attribute">proxy_timeout</span> <span class="number">1m</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> example.com:<span class="number">12345</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">53</span> udp;</span><br><span class="line">    <span class="attribute">proxy_responses</span> <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_timeout</span> <span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> dns.example.com:<span class="number">53</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> [::<span class="number">1</span>]:<span class="number">12345</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> unix:/tmp/stream.socket;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="两个proxy-pass的关系和区别"><a href="#两个proxy-pass的关系和区别" class="headerlink" title="两个proxy_pass的关系和区别"></a>两个<code>proxy_pass</code>的关系和区别</h3><p>在两个模块中，两个<code>proxy_pass</code>都是用来做后端代理的指令。<br><code>ngx_stream_proxy_module</code>模块的<code>proxy_pass</code>指令只能在server段使用使用, 只需要提供域名或ip地址和端口。可以理解为端口转发，可以是tcp端口，也可以是udp端口。<br><code>ngx_http_proxy_module</code>模块的<code>proxy_pass</code>指令需要在location段，location中的if段，limit_except段中使用，处理需要提供域名或ip地址和端口外，还需要提供协议，如”http”或”https”，还有一个可选的uri可以配置。</p><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p><strong>负载均衡是什么？</strong></p><p>我们之前使用proxy_pass的方式实现了nginx代理请求到后端的效果，随着我们的网站访问量越来越多，一个后端就不现实了，那么接下来我们应该如果在访问量日渐增大的情况下，满足线上业务的稳定呢？</p><p>解决方法就是：负载均衡</p><p>负载均衡简单说来人多力量大，打群架。</p><p>在nginx中的负载均衡主要有两种：四层负载(IP:Port)、七层负载</p><h4 id="nginx-upstream模块"><a href="#nginx-upstream模块" class="headerlink" title="nginx upstream模块"></a>nginx upstream模块</h4><p>官方介绍</p><p>官方资料：<span class="exturl" data-url="aHR0cDovL3d3dy5uZ2lueC5jbi9kb2Mvc3RhbmRhcmQvaHR0cHVwc3RyZWFtLmh0bWw=">http://www.nginx.cn/doc/standard/httpupstream.html<i class="fa fa-external-link-alt"></i></span></p><p>官方的代理属性很多，我们主要介绍upstream和ip_hash属性</p><p>官方代码示例</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line"> <span class="attribute">server</span> backend1.example.com weight=<span class="number">5</span>;</span><br><span class="line"> <span class="attribute">server</span> backend2.example.com:<span class="number">8080</span>;</span><br><span class="line"> <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="属性详解"><a href="#属性详解" class="headerlink" title="属性详解"></a>属性详解</h4><p>upstream 主要是定义一个后端服务地址的集合列表，每个后端服务使用一个server命令表示</p><p>upstream {} 和 Server {} 两部分内容属于平级关系。</p><h4 id="后端服务状态"><a href="#后端服务状态" class="headerlink" title="后端服务状态"></a>后端服务状态</h4><p>在upstream模块中，可以使用server命令指定后端服务器的地址，同时还可以设置后端服务器在负载均衡调度中的状态，常用的状态有以下几种：</p><p>down： 表示当前server主机暂时不参与负载均衡。</p><p>backup：后备主机，当所有非backup机器出现故障或者繁忙的时候，才会请求backup机器。</p><p>max_fails：允许请求的最大失败数，默认为1，配合fail_timeout一起使用</p><p>fail_timeout：经历max_fails次失败后，暂停服务的时间，默认为10s</p><h4 id="负载均衡实例"><a href="#负载均衡实例" class="headerlink" title="负载均衡实例"></a>负载均衡实例</h4><h5 id="负载均衡配置文件"><a href="#负载均衡配置文件" class="headerlink" title="负载均衡配置文件"></a>负载均衡配置文件</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backends &#123;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backends;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="后端配置文件"><a href="#后端配置文件" class="headerlink" title="后端配置文件"></a>后端配置文件</h5><h6 id="9001后端配置文件"><a href="#9001后端配置文件" class="headerlink" title="9001后端配置文件"></a>9001后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9001服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="9002后端配置文件"><a href="#9002后端配置文件" class="headerlink" title="9002后端配置文件"></a>9002后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9002</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9002服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="重启配置"><a href="#重启配置" class="headerlink" title="重启配置"></a>重启配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h5 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h5><p>反复刷新可以看到两个端口提供的内容轮番响应。</p><p><img data-src="https://img.diandian100.cn/20210401160208.png"><img data-src="https://img.diandian100.cn/20210401160218.png"></p><h4 id="负载均衡调度算法"><a href="#负载均衡调度算法" class="headerlink" title="负载均衡调度算法"></a><strong>负载均衡调度算法</strong></h4><p>Nginx提供的负载均衡策略有两种：</p><p>内置策略：nginx自带的算法</p><blockquote><p>雨露均沾型：轮训、加权轮训、哈希</p><p>定向服务型：ip_hash、least_conn、cookie、route、lean、</p><p>商业类型：ntlm、least_time、queue、stick</p></blockquote><p>扩展策略：各种结合业务场景自定义的算法或者第三方算法</p><blockquote><p>自定义算法</p><p>第三方算法：<strong>fair</strong>、<strong>url_hash</strong></p></blockquote><p>常用算法简介：</p><blockquote><p>轮询(默认)：请求按顺序逐一分配到不同的后端服务器。</p><p>weight：指定轮询权重，值越大，分配到的几率就越高，适用于后端服务器性能不均衡情况。</p><p>ip_hash：按访问IP的哈希结果分配请求，分配后访客访问固定后端服务器，有效的解决动态网页会话共享问题。</p><p>fair：基于后端服务器的响应时间来分配请求，响应时间短的优先分配。</p><p>url_hash：按访问URL的哈希结果分配请求，使同URL定向到同一台后端服务器，可提高后端缓存服务器的效率。</p></blockquote><h4 id="加权轮询实例"><a href="#加权轮询实例" class="headerlink" title="加权轮询实例"></a>加权轮询实例</h4><h5 id="负载均衡配置文件-1"><a href="#负载均衡配置文件-1" class="headerlink" title="负载均衡配置文件"></a>负载均衡配置文件</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backends &#123;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9001</span> backup; <span class="comment"># 后备主机，当所有非backup机器出现故障或者繁忙的时候，才会请求backup机器。</span></span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9002</span> weight=<span class="number">1</span>;</span><br><span class="line">		<span class="attribute">server</span> localhost:<span class="number">9003</span> weight=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backends;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="后端配置文件-1"><a href="#后端配置文件-1" class="headerlink" title="后端配置文件"></a>后端配置文件</h5><h6 id="9001后端配置文件-1"><a href="#9001后端配置文件-1" class="headerlink" title="9001后端配置文件"></a>9001后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9001服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="9002后端配置文件-1"><a href="#9002后端配置文件-1" class="headerlink" title="9002后端配置文件"></a>9002后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9002</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9002服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="9003后端配置文件"><a href="#9003后端配置文件" class="headerlink" title="9003后端配置文件"></a>9003后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9003</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9003服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="重启配置-1"><a href="#重启配置-1" class="headerlink" title="重启配置"></a>重启配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h5 id="预览-1"><a href="#预览-1" class="headerlink" title="预览"></a>预览</h5><p>9003权重最高访问频率最多，9001因为未设置了backup，只有其他服务器都故障或者繁忙的时候才会请求该主机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">我是9002服务</span><br><span class="line">我是9003服务</span><br><span class="line">我是9003服务</span><br><span class="line">……</span><br><span class="line">我是9002服务</span><br><span class="line">我是9003服务</span><br><span class="line">我是9003服务</span><br></pre></td></tr></table></figure><h4 id="ip-hash实例"><a href="#ip-hash实例" class="headerlink" title="ip_hash实例"></a>ip_hash实例</h4><h5 id="负载均衡配置文件-2"><a href="#负载均衡配置文件-2" class="headerlink" title="负载均衡配置文件"></a>负载均衡配置文件</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backends &#123;</span><br><span class="line">  	ip_hash;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">9002</span>;</span><br><span class="line">		<span class="attribute">server</span> localhost:<span class="number">9003</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backends;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="后端配置文件-2"><a href="#后端配置文件-2" class="headerlink" title="后端配置文件"></a>后端配置文件</h5><h6 id="9001后端配置文件-2"><a href="#9001后端配置文件-2" class="headerlink" title="9001后端配置文件"></a>9001后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9001服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="9002后端配置文件-2"><a href="#9002后端配置文件-2" class="headerlink" title="9002后端配置文件"></a>9002后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9002</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9002服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="9003后端配置文件-1"><a href="#9003后端配置文件-1" class="headerlink" title="9003后端配置文件"></a>9003后端配置文件</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9003</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;我是9003服务&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="重启配置-2"><a href="#重启配置-2" class="headerlink" title="重启配置"></a>重启配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h5 id="预览-2"><a href="#预览-2" class="headerlink" title="预览"></a>预览</h5><p>第一次请求被转到了9001，后续每次都被转到9001</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">我是9001服务</span><br><span class="line">我是9001服务</span><br><span class="line">我是9001服务</span><br><span class="line">……</span><br><span class="line">我是9001服务</span><br><span class="line">我是9001服务</span><br><span class="line">我是9001服务</span><br></pre></td></tr></table></figure></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/df343c71.html" rel="bookmark">服务端架构演变过程之阿里为什么能抗住90秒100亿</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/b5f2e1e2.html" rel="bookmark">nginx安装及配置多域名初体验</a></div></li></ul><footer class="post-footer"><div class="reward-container"><div>打赏个鸡腿</div><button onclick='document.querySelector(".post-reward").classList.toggle("active")'>赞赏</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="托小尼 微信"> <span>微信</span></div><div><img src="/images/alipay.jpg" alt="托小尼 支付宝"> <span>支付宝</span></div></div></div><div class="post-tags"><a href="/tags/nginx%E9%85%8D%E7%BD%AE/" rel="tag"><i class="fa fa-tag"></i> nginx配置</a> <a href="/tags/%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF/" rel="tag"><i class="fa fa-tag"></i> 状态信息</a> <a href="/tags/%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97/" rel="tag"><i class="fa fa-tag"></i> 访问日志</a> <a href="/tags/%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE/" rel="tag"><i class="fa fa-tag"></i> 限制访问</a> <a href="/tags/%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2/" rel="tag"><i class="fa fa-tag"></i> 错误页面</a> <a href="/tags/Nginx%E4%BB%A3%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> Nginx代理</a> <a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> 反向代理</a> <a href="/tags/location/" rel="tag"><i class="fa fa-tag"></i> location</a> <a href="/tags/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> 正向代理</a> <a href="/tags/%E9%99%90%E5%88%B6ip/" rel="tag"><i class="fa fa-tag"></i> 限制ip</a> <a href="/tags/access-log/" rel="tag"><i class="fa fa-tag"></i> access_log</a> <a href="/tags/return/" rel="tag"><i class="fa fa-tag"></i> return</a> <a href="/tags/try-files/" rel="tag"><i class="fa fa-tag"></i> try_files</a> <a href="/tags/%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81/" rel="tag"><i class="fa fa-tag"></i> 返回状态码</a> <a href="/tags/%E8%BF%94%E5%9B%9E%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="tag"><i class="fa fa-tag"></i> 返回字符串</a> <a href="/tags/301%E4%B8%8E302/" rel="tag"><i class="fa fa-tag"></i> 301与302</a> <a href="/tags/%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2/" rel="tag"><i class="fa fa-tag"></i> 跳转页面</a> <a href="/tags/ip-hash/" rel="tag"><i class="fa fa-tag"></i> ip_hash</a> <a href="/tags/%E6%9D%83%E9%87%8D%E8%BD%AE%E8%AF%A2/" rel="tag"><i class="fa fa-tag"></i> 权重轮询</a> <a href="/tags/%E8%BD%AE%E8%AF%A2/" rel="tag"><i class="fa fa-tag"></i> 轮询</a> <a href="/tags/proxy/" rel="tag"><i class="fa fa-tag"></i> proxy</a> <a href="/tags/proxy-pass/" rel="tag"><i class="fa fa-tag"></i> proxy_pass</a> <a href="/tags/deny/" rel="tag"><i class="fa fa-tag"></i> deny</a> <a href="/tags/allow/" rel="tag"><i class="fa fa-tag"></i> allow</a> <a href="/tags/expries/" rel="tag"><i class="fa fa-tag"></i> expries</a> <a href="/tags/stub-status/" rel="tag"><i class="fa fa-tag"></i> stub-status</a> <a href="/tags/index/" rel="tag"><i class="fa fa-tag"></i> index</a> <a href="/tags/server-name/" rel="tag"><i class="fa fa-tag"></i> server_name</a> <a href="/tags/listen/" rel="tag"><i class="fa fa-tag"></i> listen</a></div><div class="post-nav"><div class="post-nav-item"><a href="/b5f2e1e2.html" rel="prev" title="nginx安装及配置多域名初体验"><i class="fa fa-chevron-left"></i> nginx安装及配置多域名初体验</a></div><div class="post-nav-item"><a href="/1e121151.html" rel="next" title="nginx负载均衡">nginx负载均衡 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="comments"><div id="SOHUCS"></div></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbg==">豫ICP备17028303号-1 </span><img src="http://www.beian.gov.cn/portal/download" style="display:inline-block"><span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5nb3YuY24vcG9ydGFsL3JlZ2lzdGVyU3lzdGVtSW5mbz9yZWNvcmRjb2RlPTE3MDI4MzAz">豫公网安备 41102402000095号</span></div><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Tony Yu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">1.5m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">22:27</span></span></div></div></footer><script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments('#SOHUCS', () => {
    NexT.utils.getScript('https://changyan.sohu.com/upload/changyan.js', () => {
      window.changyan.api.config({
        appid: 'cyu11Umgd',
        conf : '0f296687f6a61e82028fd7c6ddf32ab9'
      });
    });
  });</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script></body></html>